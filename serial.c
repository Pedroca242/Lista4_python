/* Necessário para funções e macros básicas */
#include <avr/io.h>

/* Os próximos dois includes são necessários quando se usa interrupçoes */
#include <avr/cpufunc.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>

#include <stdint.h>

const uint8_t data[] PROGMEM = {
  0,   0,   0,   0,   1,   0, 198, 254,   2,   0, 141, 253, 
  3,   0,  83, 252,   4,   0,  27, 251,   5,   0, 228, 249, 
  6,   0, 175, 248,   7,   0, 123, 247,   8,   0,  74, 246, 
  9,   0,  27, 245,  10,   0, 238, 243,  11,   0, 197, 242, 
 12,   0, 159, 241,  13,   0, 125, 240,  14,   0,  95, 239, 
 15,   0,  69, 238,  16,   0,  47, 237,  17,   0,  30, 236, 
 18,   0,  18, 235,  19,   0,  12, 234,  20,   0,  11, 233, 
 21,   0,  15, 232,  22,   0,  26, 231,  23,   0,  43, 230, 
 24,   0,  67, 229,  25,   0,  97, 228,  26,   0, 135, 227, 
 27,   0, 179, 226,  28,   0, 231, 225,  29,   0,  35, 225, 
 30,   0, 102, 224,  31,   0, 178, 223,  32,   0,   5, 223, 
 33,   0,  97, 222,  34,   0, 197, 221,  35,   0,  50, 221, 
 36,   0, 168, 220,  37,   0,  39, 220,  38,   0, 175, 219, 
 39,   0,  64, 219,  40,   0, 218, 218,  41,   0, 126, 218, 
 42,   0,  43, 218,  43,   0, 225, 217,  44,   0, 162, 217, 
 45,   0, 108, 217,  46,   0,  63, 217,  47,   0,  29, 217, 
 48,   0,   4, 217,  49,   0, 245, 216,  50,   0, 240, 216, 
 51,   0, 245, 216,  52,   0,   4, 217,  53,   0,  29, 217, 
 54,   0,  63, 217,  55,   0, 108, 217,  56,   0, 162, 217, 
 57,   0, 225, 217,  58,   0,  43, 218,  59,   0, 126, 218, 
 60,   0, 218, 218,  61,   0,  64, 219,  62,   0, 175, 219, 
 63,   0,  39, 220,  64,   0, 168, 220,  65,   0,  50, 221, 
 66,   0, 197, 221,  67,   0,  97, 222,  68,   0,   5, 223, 
 69,   0, 178, 223,  70,   0, 102, 224,  71,   0,  35, 225, 
 72,   0, 231, 225,  73,   0, 179, 226,  74,   0, 135, 227, 
 75,   0,  97, 228,  76,   0,  67, 229,  77,   0,  43, 230, 
 78,   0,  26, 231,  79,   0,  15, 232,  80,   0,  11, 233, 
 81,   0,  12, 234,  82,   0,  18, 235,  83,   0,  30, 236, 
 84,   0,  47, 237,  85,   0,  69, 238,  86,   0,  95, 239, 
 87,   0, 125, 240,  88,   0, 159, 241,  89,   0, 197, 242, 
 90,   0, 238, 243,  91,   0,  27, 245,  92,   0,  74, 246, 
 93,   0, 123, 247,  94,   0, 175, 248,  95,   0, 228, 249, 
 96,   0,  27, 251,  97,   0,  83, 252,  98,   0, 141, 253, 
 99,   0, 198, 254, 100,   0,   0,   0, 101,   0,  58,   1, 
102,   0, 115,   2, 103,   0, 173,   3, 104,   0, 229,   4, 
105,   0,  28,   6, 106,   0,  81,   7, 107,   0, 133,   8, 
108,   0, 182,   9, 109,   0, 229,  10, 110,   0,  18,  12, 
111,   0,  59,  13, 112,   0,  97,  14, 113,   0, 131,  15, 
114,   0, 161,  16, 115,   0, 187,  17, 116,   0, 209,  18, 
117,   0, 226,  19, 118,   0, 238,  20, 119,   0, 244,  21, 
120,   0, 245,  22, 121,   0, 241,  23, 122,   0, 230,  24, 
123,   0, 213,  25, 124,   0, 189,  26, 125,   0, 159,  27, 
126,   0, 121,  28, 127,   0,  77,  29, 128,   0,  25,  30, 
129,   0, 221,  30, 130,   0, 154,  31, 131,   0,  78,  32, 
132,   0, 251,  32, 133,   0, 159,  33, 134,   0,  59,  34, 
135,   0, 206,  34, 136,   0,  88,  35, 137,   0, 217,  35, 
138,   0,  81,  36, 139,   0, 192,  36, 140,   0,  38,  37, 
141,   0, 130,  37, 142,   0, 213,  37, 143,   0,  31,  38, 
144,   0,  94,  38, 145,   0, 148,  38, 146,   0, 193,  38, 
147,   0, 227,  38, 148,   0, 252,  38, 149,   0,  11,  39, 
150,   0,  16,  39, 151,   0,  11,  39, 152,   0, 252,  38, 
153,   0, 227,  38, 154,   0, 193,  38, 155,   0, 148,  38, 
156,   0,  94,  38, 157,   0,  31,  38, 158,   0, 213,  37, 
159,   0, 130,  37, 160,   0,  38,  37, 161,   0, 192,  36, 
162,   0,  81,  36, 163,   0, 217,  35, 164,   0,  88,  35, 
165,   0, 206,  34, 166,   0,  59,  34, 167,   0, 159,  33, 
168,   0, 251,  32, 169,   0,  78,  32, 170,   0, 154,  31, 
171,   0, 221,  30, 172,   0,  25,  30, 173,   0,  77,  29, 
174,   0, 121,  28, 175,   0, 159,  27, 176,   0, 189,  26, 
177,   0, 213,  25, 178,   0, 230,  24, 179,   0, 241,  23, 
180,   0, 245,  22, 181,   0, 244,  21, 182,   0, 238,  20, 
183,   0, 226,  19, 184,   0, 209,  18, 185,   0, 187,  17, 
186,   0, 161,  16, 187,   0, 131,  15, 188,   0,  97,  14, 
189,   0,  59,  13, 190,   0,  18,  12, 191,   0, 229,  10, 
192,   0, 182,   9, 193,   0, 133,   8, 194,   0,  81,   7, 
195,   0,  28,   6, 196,   0, 229,   4, 197,   0, 173,   3, 
198,   0, 115,   2, 199,   0,  58,   1, 
};
int g_idx;
const int g_size = sizeof(data);
uint8_t next;

ISR(USART_UDRE_vect) {
    UDR0 = next;
    if (++g_idx < g_size) {
        next = pgm_read_byte(data + g_idx);
    } else {
        g_idx = 0;
        next = pgm_read_byte(data);
        UCSR0B &= ~((1 << TXEN0) | (1 << UDRIE0));
    }
}

#define MAX_CNT 128
#define CTR_MASK ((1 << 5) - 1)
ISR(TIMER0_OVF_vect) {
    static uint16_t ctr;

    if (!(++ctr & CTR_MASK))
        PINB = (1 << PB5);

    if (ctr < MAX_CNT)
        return;

    ctr = 0;
    if (UCSR0B & (1 << TXEN0))
        return;
    UCSR0B = (1 << TXEN0) | (1 << UDRIE0);
}

int main(void) {
    next = pgm_read_byte(data);

    UCSR0A = 0;
    UCSR0B = 0;
    UCSR0C = (1 << UCSZ01) | (1 << UCSZ00);
    UBRR0 = 8;

    TIFR0 = (1 << TOV0);
    TIMSK0 = (1 << TOIE0);
    TCCR0A = 0;
    TCCR0B = ((1 << CS02) | (1 << CS00));

    DDRB |= (1 << PB5);
    PORTB &= ~(1 << PB5);

    sei();

    while (1) {
    }

    return 0;
}
